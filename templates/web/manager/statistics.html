{% extends 'web/base.html' %}
{% load static %}
{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂{% endblock %}
{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
	<h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h1>
	
	<!-- –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
	<div class="card" style="margin-bottom: 20px;">
		<h2 style="margin: 0 0 15px 0;">üìÖ –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞</h2>
		<form method="get" style="display: flex; gap: 15px; align-items: end;">
			<div>
				<label style="display: block; margin-bottom: 5px; font-weight: 600;">–ü–µ—Ä–∏–æ–¥:</label>
				<select name="period" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
					<option value="week" {% if period == 'week' %}selected{% endif %}>–ó–∞ –Ω–µ–¥–µ–ª—é</option>
					<option value="month" {% if period == 'month' %}selected{% endif %}>–ó–∞ –º–µ—Å—è—Ü</option>
					<option value="quarter" {% if period == 'quarter' %}selected{% endif %}>–ó–∞ –∫–≤–∞—Ä—Ç–∞–ª</option>
				</select>
			</div>
			<button type="submit" class="btn">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
		</form>
		<p style="margin: 10px 0 0 0; color: var(--muted); font-size: 0.9em;">
			–ü–µ—Ä–∏–æ–¥: —Å {{ start_date|date:"d.m.Y" }} –ø–æ —Å–µ–≥–æ–¥–Ω—è
		</p>
	</div>
	
	<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
	<div class="grid" style="margin-bottom: 30px;">
		<div class="card">
			<h3 style="margin: 0 0 10px 0; color: var(--muted);">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</h3>
			<p style="font-size: 2.5em; margin: 0; color: var(--primary); font-weight: bold;">{{ total_orders }}</p>
		</div>
		<div class="card">
			<h3 style="margin: 0 0 10px 0; color: var(--muted);">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h3>
			<p style="font-size: 2.5em; margin: 0; color: #10b981; font-weight: bold;">{{ total_revenue|floatformat:0 }} ‚ÇΩ</p>
		</div>
		<div class="card">
			<h3 style="margin: 0 0 10px 0; color: var(--muted);">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</h3>
			<p style="font-size: 2.5em; margin: 0; color: #f59e0b; font-weight: bold;">
				{% if total_orders > 0 %}{{ avg_order_value|floatformat:0 }}{% else %}0{% endif %} ‚ÇΩ
			</p>
		</div>
	</div>
	
	<!-- –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å—É–º–º–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π -->
	<div class="card" style="margin-bottom: 30px;">
		<h2 style="margin: 0 0 20px 0;">üí∞ –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å—É–º–º–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</h2>
		{% if orders_by_sum_30 %}
		<div style="height: 400px;">
			<canvas id="ordersBySumChart"></canvas>
		</div>
		{% else %}
		<p style="color: var(--muted); text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</p>
		{% endif %}
	</div>
	
	<!-- –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π -->
	<div class="card" style="margin-bottom: 30px;">
		<h2 style="margin: 0 0 20px 0;">üìä –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</h2>
		{% if orders_by_count_30 %}
		<div style="height: 400px;">
			<canvas id="ordersByCountChart"></canvas>
		</div>
		{% else %}
		<p style="color: var(--muted); text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</p>
		{% endif %}
	</div>
	
	<!-- –¢–æ–ø-10 –∫–Ω–∏–≥ -->
	<div class="card" style="margin-bottom: 30px;">
		<h2 style="margin: 0 0 20px 0;">üìö –¢–æ–ø-10 –∫–Ω–∏–≥ –∑–∞ –ø–µ—Ä–∏–æ–¥</h2>
		{% if top_books %}
		<div style="overflow-x: auto;">
			<table style="width: 100%; border-collapse: collapse;">
				<thead style="background: var(--bg);">
					<tr>
						<th style="padding: 12px; text-align: left;">–ü–æ–∑–∏—Ü–∏—è</th>
						<th style="padding: 12px; text-align: left;">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏</th>
						<th style="padding: 12px; text-align: center;">–ó–∞–∫–∞–∑–æ–≤</th>
						<th style="padding: 12px; text-align: center;">–ü—Ä–æ–¥–∞–Ω–æ</th>
						<th style="padding: 12px; text-align: right;">–í—ã—Ä—É—á–∫–∞</th>
					</tr>
				</thead>
				<tbody>
					{% for book in top_books %}
					<tr style="border-top: 1px solid var(--border);">
						<td style="padding: 12px; text-align: center; font-weight: 600; color: var(--muted);">{{ forloop.counter }}</td>
						<td style="padding: 12px;">
							<div>
								<strong>{{ book.title }}</strong><br>
								<small style="color: var(--muted);">ISBN: {{ book.isbn }}</small>
							</div>
						</td>
						<td style="padding: 12px; text-align: center; font-weight: 600;">{{ book.orders_count }}</td>
						<td style="padding: 12px; text-align: center; font-weight: 600;">{{ book.quantity_sold|default:0 }}</td>
						<td style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">{{ book.revenue|floatformat:0|default:0 }} ‚ÇΩ</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
		<p style="color: var(--muted); text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
		{% endif %}
	</div>
	
	<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
	<div style="display: flex; gap: 10px;">
		<a href="/manager/" class="btn btn-ghost">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏</a>
		<a href="/manager/orders/" class="btn">üìã –ó–∞–∫–∞–∑—ã</a>
	</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
	console.log('Chart.js loaded:', typeof Chart !== 'undefined');
	
	{% if orders_by_sum_30 %}
	// –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å—É–º–º–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
	const ordersBySumCtx = document.getElementById('ordersBySumChart');
	if (ordersBySumCtx && typeof Chart !== 'undefined') {
		const ordersBySumData = {
			labels: [
				{% for stat in orders_by_sum_30 %}
				'{{ stat.day|date:"d.m" }}'{% if not forloop.last %},{% endif %}
				{% endfor %}
			],
			datasets: [{
				label: '–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ (‚ÇΩ)',
				data: [
					{% for stat in orders_by_sum_30 %}
					{% if stat.total_sum %}{{ stat.total_sum|floatformat:0 }}{% else %}0{% endif %}{% if not forloop.last %},{% endif %}
					{% endfor %}
				],
				borderColor: 'rgb(16, 185, 129)',
				backgroundColor: 'rgba(16, 185, 129, 0.1)',
				tension: 0.4,
				fill: true,
				pointRadius: 4,
				pointHoverRadius: 6
			}]
		};
		
		new Chart(ordersBySumCtx.getContext('2d'), {
			type: 'line',
			data: ordersBySumData,
			options: {
				responsive: true,
				maintainAspectRatio: true,
				plugins: {
					legend: {
						display: true,
						position: 'top'
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						title: {
							display: true,
							text: '–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ (‚ÇΩ)'
						}
					},
					x: {
						ticks: {
							maxRotation: 45,
							minRotation: 45
						}
					}
				}
			}
		});
	}
	{% endif %}
	
	{% if orders_by_count_30 %}
	// –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
	const ordersByCountCtx = document.getElementById('ordersByCountChart');
	if (ordersByCountCtx && typeof Chart !== 'undefined') {
		const ordersByCountData = {
			labels: [
				{% for stat in orders_by_count_30 %}
				'{{ stat.day|date:"d.m" }}'{% if not forloop.last %},{% endif %}
				{% endfor %}
			],
			datasets: [{
				label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤',
				data: [
					{% for stat in orders_by_count_30 %}
					{{ stat.orders_count|default:0 }}{% if not forloop.last %},{% endif %}
					{% endfor %}
				],
				borderColor: 'rgb(37, 99, 235)',
				backgroundColor: 'rgba(37, 99, 235, 0.6)',
				borderWidth: 1
			}]
		};
		
		new Chart(ordersByCountCtx.getContext('2d'), {
			type: 'bar',
			data: ordersByCountData,
			options: {
				responsive: true,
				maintainAspectRatio: true,
				plugins: {
					legend: {
						display: true,
						position: 'top'
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						title: {
							display: true,
							text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤'
						},
						ticks: {
							stepSize: 1
						}
					},
					x: {
						ticks: {
							maxRotation: 45,
							minRotation: 45
						}
					}
				}
			}
		});
	}
	{% endif %}
});
</script>
{% endblock %}
